'use strict';

var ENEXT = ENEXT || {};
var ENEXT_SRV = ENEXT_SRV || {};

ENEXT.registration = (function($) {

    var BUTTONANCHORCLASS = '.ednx-enroll-button-js';
    var OPENEDX_DOMAIN = ENEXT_SRV.lms_base_url;
    var ENROLLMENT_API_LOCATION = OPENEDX_DOMAIN + ENEXT_SRV.enrollment_api_location;

    var template = function(url, btnLabel, containerClasses, buttonClasses) {
        return '' +
            '<div class="' + containerClasses + '">' +
            '<a class="' + buttonClasses + '" href="' + url + '">' + btnLabel + '</a>' +
            '</div>' +
            '';
    }

    var renderActionBtn = function(action, $anchor, url) {
        var settings = window[$anchor.data('settings')];

        var containerClasses = settings['container_class_' + action] || settings.container_class_generic;
        var buttonClasses = settings['button_class_' + action] || settings.button_class_generic;
        var colorClass = settings['color_class_' + action] || settings.color_class_generic;
        var label = settings['label_' + action];
        url = url || '#';

        $anchor.html(template(url, label, containerClasses, buttonClasses));
        $anchor.find('a').addClass(colorClass);
    }

    var isCourseRegistrationOpen = function(courseData) {
        return (new Date(Date.parse(courseData.enrollment_start) || Date.now()) <= Date.now()) &&
            (Date.now() <= new Date(Date.parse(courseData.enrollment_end) || Date.now()))
    }

    var getCourseData = function(courseID) {
        var urlCourse = ENROLLMENT_API_LOCATION + 'course/' + courseID + '?include_expired=1';
        return $.ajax({
            url: urlCourse,
            type: 'GET',
            dataType: 'json',
            xhrFields: {
                withCredentials: true
            }
        });
    }

    var amIEnrolledIn = function (enrollmentData, courseID) {
      var courseData = data;
      var amIEnrolled = Boolean($.grep(enrollmentData, function(row) {
            return row['course_details']['course_id'] == courseID
        }).length);
    }

    var renderButtons = function(courseData, enrollmentData, $anchor) {
        var amIEnrolled = amIEnrolledIn(enrollmentData, courseData.course_id);
        var hasCourseStarted = (new Date(Date.parse(courseData.course_start))) <= Date.now();
        var isInvitationOnly = Boolean(courseData.invite_only);
        var isRegistrationOpen = isCourseRegistrationOpen(courseData);
        var userEnrollmentUrl = ENEXT_SRV.user_enrollment_url;
        var courseHasNotStartedUrl = ENEXT_SRV.course_has_not_started_url;

        // Big decisition tree
        if (amIEnrolled) {
            if (hasCourseStarted) {
                renderActionBtn('go_to_course', $anchor, OPENEDX_DOMAIN + '/courses/' + courseData.course_id + '/info');
            } else {
                renderActionBtn('course_has_not_started', $anchor, OPENEDX_DOMAIN + courseHasNotStartedUrl);
            }
        } else if (isInvitationOnly) {
            renderActionBtn('invitation_only', $anchor);
        } else if (isRegistrationOpen) {
            renderActionBtn('enroll_not_logged_in', $anchor, OPENEDX_DOMAIN + '/register?course_id=' + courseData.course_id + '&enrollment_action=enroll');
        } else {
            renderActionBtn('enrollment_closed', $anchor);
        }
    }

    var init = function() {
        // find the enrollment information for the user
        var urlEnrollments = ENROLLMENT_API_LOCATION + 'enrollment';
        var enrollmentData = [];

        var enrollmentsXhr = $.ajax({
                url: urlEnrollments,
                type: 'GET',
                dataType: 'json',
                xhrFields: {
                    withCredentials: true
                }
            })
            .done(function(data) {
                enrollmentData = data;
            })
            .always(function() {
                $(BUTTONANCHORCLASS).each(function(index, elem) {
                    var $anchor = $(elem);
                    var courseID = $anchor.data('course-id');

                    getCourseData(courseID).done(function(courseData) {
                        renderButtons(courseData, enrollmentData, $anchor);
                    });
                });
            });
    }

    return {
        init: init
    }

})(jQuery);

ENEXT.registration.init();