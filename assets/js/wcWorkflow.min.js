'use strict';
window.ENEXT = window.ENEXT || {};

ENEXT.OPENEDX_DOMAIN = ENEXT_SRV.lms_base_url;
ENEXT.LOGIN_NEXT = ENEXT_SRV.lms_wp_return_path;
ENEXT.LOGIN_PATH = ENEXT_SRV.lms_login_path;
ENEXT.RUN_FUNCTIONS = ENEXT_SRV.run_functions;


ENEXT.callMeAtOpenEdx = function() {
    return jQuery.ajax({
        url: ENEXT.OPENEDX_DOMAIN + "/api/user/v1/me",
        method: "GET",
        xhrFields: {
            withCredentials: true
        }
    })
}

ENEXT.assertOpenEdxLoggedIn = function() {
    ENEXT.callMeAtOpenEdx().fail(function(xhr) {
        if (xhr.status === 401) {
            // Not logged in, redirecting
            window.location.replace(ENEXT.OPENEDX_DOMAIN + "/" + ENEXT.LOGIN_PATH + "?next=" + ENEXT.LOGIN_NEXT);
        }
        else if (xhr.status === 0) {
            // Not able to find info, most likely CORS
            console.warn("The openedx integrator plugin tried to find the user session but was not allowed. This is likely a CORS settings problem.");
        }
        else {
            // Different problem
            console.warn("The openedx integrator plugin found an unexpected response from the server at: " + ENEXT.OPENEDX_DOMAIN);
        }
    });
};

// Run the defined functions
for (var i = ENEXT.RUN_FUNCTIONS .length - 1; i >= 0; i--) {
    ENEXT[ENEXT.RUN_FUNCTIONS[i]]();
}
