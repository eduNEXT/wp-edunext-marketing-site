'use strict';
window.ENEXT = window.ENEXT || {};

ENEXT.OPENEDX_DOMAIN = ENEXT_SRV.lms_base_url;
ENEXT.LOGIN_NEXT = ENEXT_SRV.lms_wp_return_path;
ENEXT.LOGIN_PATH = ENEXT_SRV.lms_login_path;
ENEXT.RUN_FUNCTIONS = ENEXT_SRV.run_functions;
ENEXT.PREFILL_MAPPINGS = ENEXT_SRV.prefill_mappings;

ENEXT.CACHE = {};


ENEXT.callApiAtOpenEdx = function(endpoint) {
    if ('api_user_v1_' + endpoint in ENEXT.CACHE) {
        return ENEXT.CACHE['api_user_v1_' + endpoint];
    }
    ENEXT.CACHE['api_user_v1_' + endpoint] = jQuery.ajax({
        url: ENEXT.OPENEDX_DOMAIN + "/api/user/v1/" + endpoint,
        method: "GET",
        xhrFields: {
            withCredentials: true
        }
    })
    return ENEXT.CACHE['api_user_v1_' + endpoint];
}

ENEXT.assertOpenEdxLoggedIn = function(includeData) {
    var endpoint = 'me';
    if (includeData) {
        var endpoint = 'accounts';
    }

    ENEXT.callApiAtOpenEdx(endpoint).fail(function(xhr) {
        if (xhr.status === 401) {
            // Not logged in, redirecting
            window.location.replace(ENEXT.OPENEDX_DOMAIN + "/" + ENEXT.LOGIN_PATH + "?next=" + ENEXT.LOGIN_NEXT);
        }
        else if (xhr.status === 0) {
            // Not able to find info, most likely CORS
            console.warn("The openedx integrator plugin tried to find the user session but was not allowed. This is likely a CORS settings problem.");
        }
        else {
            // Different problem
            console.warn("The openedx integrator plugin found an unexpected response from the server at: " + ENEXT.OPENEDX_DOMAIN);
        }
    });
};

ENEXT.assertOpenEdxLoggedInWithData = function(includeData) {
    ENEXT.assertOpenEdxLoggedIn(true);
}

ENEXT.prefillVisibleFields = function() {
    ENEXT.callApiAtOpenEdx('accounts').success(function(dataArray) {
        var data = dataArray[0];
        var mappings = JSON.parse(ENEXT.PREFILL_MAPPINGS);
        for (var prop in mappings) {
            jQuery('form[name="checkout"] #' + prop).val(data[mappings[prop]]);
        }
    });
}

ENEXT.addInfoToCheckout = function() {
    ENEXT.callApiAtOpenEdx('accounts').success(function(dataArray) {
        var data = dataArray[0];
        var fields = ['username', 'name', 'email'];
        for (var i = fields.length - 1; i >= 0; i--) {
            if (fields[i] in data) {
                jQuery('form[name="checkout"]').append('<input type="hidden" name="wpt_oer_' + fields[i] + '" value="' + data[fields[i]] + '">');
            }
            else {
                console.warn("The openedx integrator plugin could not find the " + fields[i] + " to insert to the checkout form.");
            }
        }
    });
};

// Run the defined functions
for (var i = 0; i < ENEXT.RUN_FUNCTIONS.length; i++) {
    ENEXT[ENEXT.RUN_FUNCTIONS[i]]();
}
