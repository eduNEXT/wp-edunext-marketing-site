'use strict';
window.ENEXT = window.ENEXT || {};

ENEXT.OPENEDX_DOMAIN = ENEXT_SRV.lms_base_url;
ENEXT.LOGIN_NEXT = ENEXT_SRV.lms_wp_return_path;
ENEXT.LOGIN_PATH = ENEXT_SRV.lms_login_path;
ENEXT.RUN_FUNCTIONS = ENEXT_SRV.run_functions;

ENEXT.CACHE = {};


ENEXT.callMeAtOpenEdx = function() {
    if ('api_user_v1_me' in ENEXT.CACHE) {
        return ENEXT.CACHE['api_user_v1_me'];
    }
    ENEXT.CACHE['api_user_v1_me'] = jQuery.ajax({
        url: ENEXT.OPENEDX_DOMAIN + "/api/user/v1/me",
        method: "GET",
        xhrFields: {
            withCredentials: true
        }
    })
    return ENEXT.CACHE['api_user_v1_me'];
}

ENEXT.assertOpenEdxLoggedIn = function() {
    ENEXT.callMeAtOpenEdx().fail(function(xhr) {
        if (xhr.status === 401) {
            // Not logged in, redirecting
            window.location.replace(ENEXT.OPENEDX_DOMAIN + "/" + ENEXT.LOGIN_PATH + "?next=" + ENEXT.LOGIN_NEXT);
        }
        else if (xhr.status === 0) {
            // Not able to find info, most likely CORS
            console.warn("The openedx integrator plugin tried to find the user session but was not allowed. This is likely a CORS settings problem.");
        }
        else {
            // Different problem
            console.warn("The openedx integrator plugin found an unexpected response from the server at: " + ENEXT.OPENEDX_DOMAIN);
        }
    });
};

ENEXT.addUsernameToCheckout = function() {
    ENEXT.callMeAtOpenEdx().success(function(data) {
        if ('username' in data) {
            var apiUsername = data.username;
            jQuery('form[name="checkout"]').append('<input type="hidden" name="wpt_oer_username" value="' + apiUsername + '">');
        }
        else {
            console.warn("The openedx integrator plugin could not find the username to insert to the checkout form.");
        }
    });
};

// Run the defined functions
for (var i = 0; i < ENEXT.RUN_FUNCTIONS.length; i++) {
    ENEXT[ENEXT.RUN_FUNCTIONS[i]]();
}
