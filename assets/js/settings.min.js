jQuery(document).ready(function(e){e(".colorpicker").hide();e(".colorpicker").each(function(){e(this).farbtastic(e(this).closest(".color-picker").find(".color"))});e(".color").click(function(){e(this).closest(".color-picker").find(".colorpicker").fadeIn()});e(document).mousedown(function(){e(".colorpicker").each(function(){var t=e(this).css("display");t=="block"&&e(this).fadeOut()})});var t;jQuery.fn.uploadMediaFile=function(e,n){var r=e.attr("id"),i=r.replace("_button",""),s=r.replace("_button","_preview");if(t){t.open();return}t=wp.media.frames.file_frame=wp.media({title:jQuery(this).data("uploader_title"),button:{text:jQuery(this).data("uploader_button_text")},multiple:!1});t.on("select",function(){attachment=t.state().get("selection").first().toJSON();jQuery("#"+i).val(attachment.id);n&&jQuery("#"+s).attr("src",attachment.sizes.thumbnail.url);t=!1});t.open()};jQuery(".image_upload_button").click(function(){jQuery.fn.uploadMediaFile(jQuery(this),!0)});jQuery(".image_delete_button").click(function(){jQuery(this).closest("td").find(".image_data_field").val("");jQuery(this).closest("td").find(".image_preview").remove();return!1})});
jQuery(document).ready(function($){

    var isGeneralSettingsTab = Boolean($('[name="wpt_lms_base_url"]').length);
    var isEoxApiTab = Boolean($('[name="wpt_eox_client_id"]').length);
	var $statuses = $('<div class="eox-status-container"></div>');

	var create$span = function () {
		return $('<span></span>').css({'font-weight': 'bold'}).appendTo($statuses);
	}

    var $logCookieStatus = create$span();
    var $sessionCookieStatus = create$span();
    var $fetchStatus = create$span();
    var $eoxStatus = create$span();
    $statuses.appendTo('form[action="options.php"]');

    var testing = function(){
    	// Cookie testing
        if (ENEXT.amILoggedIn()) {
            $logCookieStatus.html(' ✓ Cookie for logged-in users found! ').removeClass('error');
        } else {
            $logCookieStatus.html(' ✘ Cookie for logged-in users not found ').addClass('error');
        }

    	// Cookie testing
        if (document.cookie.indexOf(ENEXT_SRV.user_info_cookie_name + '=') !== -1) {
            $sessionCookieStatus.html(' ✓ Cookie with user info found! ').removeClass('error');
        } else {
            $sessionCookieStatus.html(' ✘ Cookie with user info not found').addClass('error');
        }

    	// Enrollment API testing
        ENEXT.getEnrollmentInfo().done(function () {
        	$fetchStatus.html('✓ Enrollment API fetching success!').removeClass('error');
        }).fail(function (response) {
        	var error = '✘ Enrollment API fetching failed!'
        	if (response.responseText) {
        		error += ' Response: ' + response.responseText + ',';
        	}
        	error += ' (status: ' + response.status + ')';

        	$fetchStatus.html(error).addClass('error');
        });

    	// EOX core api testing
        var data = {
        	'action': 'get_userinfo_ajax',
        	'_ajax_nonce': ENEXT_SRV.nonce
        };
        jQuery.post(ajaxurl, data).done(function(html) {
        	$eoxStatus.html(' ✓ EOX api calling success! ').removeClass('error');
        }).fail(function (err) {
            console.log(err);
        	$eoxStatus.html(' ✘ EOX api calling failed! ').addClass('error')
        });
    }

    for (var i = 0; i <= 48; i++) {
        setTimeout(testing, i * 5000);
        if (i === 40) {
            setTimeout(function () {
                var message = 'Reload the page to test again';
                $('<span>').html(message).addClass('reload-warning').appendTo($statuses);
            }, i * 5000)
        }
    }

});