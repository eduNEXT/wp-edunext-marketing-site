'use strict';
window.ENEXT = window.ENEXT || {};

jQuery(document).ready(function ($) {

    ENEXT.checkCookie = function () {
        return document.cookie.indexOf(ENEXT_SRV_CS.is_loggedin_cookie_name + '=true') !== -1;
    }

    ENEXT.getCookieInfo = function () {
        var user_cookie = document.cookie.split(';').filter(
            (item) => item.trim().startsWith(ENEXT_SRV_CS.user_info_cookie_name));

        var user_cookie_info = user_cookie[0].split('=')[1]
        user_cookie_info = user_cookie_info.replace(/\\054/gi, ",");
        var json_data = JSON.parse(JSON.parse(user_cookie_info));
        return json_data;
    }

    ENEXT.renderMenu = function () {

        var logged_in =  ENEXT.checkCookie();

        if (logged_in) {
            $(".login_or_menu_openedx a:first").text('__username__');
            $(".login_or_menu_openedx  a:first").hide();
            $(".profile_openedx a:first").href = '__learner_profile__';
            $(".account_openedx a:first").href = '__account_settings__';
            $(".signout_openedx a:first").href = '__logout__';
            $(".login_or_dash_openedx a:first").text('Dashboard');
            $(".menu_openedx a:first").text('__username__');
            $(".menu_openedx a:first").hide();
            $(".login_openedx").hide();
            $(".register_openedx").hide();
            $(".resume_openedx a:first").href = '__resume_block__';
            ENEXT.renderLinks();
        } else {
            $(".login_or_menu_openedx a:first").text('Login');
            $(".dashboard_openedx").hide();
            $(".profile_openedx").hide();
            $(".account_openedx").hide();
            $(".signout_openedx").hide();
            $(".login_or_dash_openedx a:first").text('Login');
            $(".menu_openedx").hide();
            $(".resume_openedx").hide();
        }

        ENEXT.renderCustomSettings(logged_in);
    }

    ENEXT.renderCustomSettings = function (logged_in) {

        if (logged_in){
            for (let item of ENEXT_SRV_CS.hide_if_logged_in) {
                $(".menu-item-"+item).hide();
            }
        } else {
            for (let item of ENEXT_SRV_CS.hide_if_not_logged_in) {
                $(".menu-item-"+item).hide();
            }
        }
    }

    ENEXT.renderLinks = function () {

        var user_data = ENEXT.getCookieInfo();
        var reg_exp = /__(?<value>\w+)__/

        $(".open-edx-link").each(function () {
            var item = $(this);
            item = item.children('a')[0];

            var replace_name = item.text.match(reg_exp);
            var replace_url = item.href.match(reg_exp);

            if (replace_name) {
                let new_name = replace_name.groups.value;
                item.text = user_data[new_name];
                $(item).show()
            }

            if (replace_url) {
                let new_url = replace_url.groups.value;
                item.href = user_data["header_urls"][new_url];
            }
        });
    }


    ENEXT.renderMenu();

});