'use strict';
window.ENEXT = window.ENEXT || {};

ENEXT.LOGGEDIN_COOKIE_NAME = ENEXT_SRV_CS.is_loggedin_cookie_name;
ENEXT.USERINFO_COOKIE_NAME = ENEXT_SRV_CS.user_info_cookie_name;
ENEXT.DASHBOARD_URL = ENEXT_SRV_CS.dashboard_url;
ENEXT.LOGIN_URL = ENEXT_SRV_CS.login_url;
ENEXT.REGISTER_URL = ENEXT_SRV_CS.register_url;
ENEXT.HIDE_WHEN_LOGGED_IN = ENEXT_SRV_CS.hide_if_logged_in;
ENEXT.HIDE_WHEN_LOGGED_OUT = ENEXT_SRV_CS.hide_if_not_logged_in;

jQuery(document).ready(function ($) {

    ENEXT.getCookie = function (name) {
        var value = "; " + document.cookie;
        var parts = value.split("; " + name + "=");
        if (parts.length == 2) return parts.pop().split(";").shift();
    };


    ENEXT.loggedInCookiePresent = function () {
        return document.cookie.indexOf(ENEXT.LOGGEDIN_COOKIE_NAME + '=true') !== -1;
    }

    ENEXT.getCookieInfo = function () {
        var user_cookie = ENEXT.getCookie(ENEXT.USERINFO_COOKIE_NAME);

        if (typeof user_cookie === 'undefined') {
            return;
        }
        var user_cookie_info = user_cookie.replace(/\\054/gi, ",");
        return JSON.parse(JSON.parse(user_cookie_info));
    }


    ENEXT.renderMenu = function () {
        var isLoggedIn =  ENEXT.loggedInCookiePresent();

        ENEXT.filterInvalids();
        ENEXT.renderLinks();
        ENEXT.fixupTreeLeaves();
    }

    ENEXT.renderLinks = function () {
        var user_data = ENEXT.getCookieInfo();
        if (typeof user_data === 'undefined') {
            return;
        }

        $(".open-edx-link").each(function (index, item) {
            var $item = $(item);
            var final_html = $item.html();
            final_html = final_html.replace(/#__USERNAME__/i, user_data['username']);

            var header_urls = user_data['header_urls'];
            final_html = final_html.replace(/#__RESUME_BLOCK__/i, header_urls['resume_block']);
            final_html = final_html.replace(/#__LEARNER_PROFILE__/i, header_urls['learner_profile']);
            final_html = final_html.replace(/#__ACCOUNT_SETTINGS__/i, header_urls['account_settings']);
            final_html = final_html.replace(/#__LOGOUT__/i, header_urls['logout']);

            $item.html(final_html);
        });
    };

    ENEXT.computeConditionalItem = function ($item, isLoggedIn) {
        var regExp = /{{.+}}/gi;
        var ocurrences = $item.html().match(regExp);

        for (var i = 0; i < ocurrences.length; i++) {
            var inner = ocurrences[i].substring(0, ocurrences[i].length - 2).substring(2);

            var result;
            if (inner.indexOf('/') > -1) {
                if (isLoggedIn) {
                    result = inner.split('/')[1];
                }
                else {
                    result = inner.split('/')[0];

                    $('a', $item).each(function(index, anchor) {
                        var $anchor = $(anchor);
                        $anchor.attr('href', ENEXT.LOGIN_URL);
                    });
                }
            }
            var final_html = $item.html();
            final_html = final_html.replace(ocurrences[i], result);
            $item.html(final_html);
        }
    };

    ENEXT.fixupTreeLeaves = function () {
        // Removes the carets when a menu item has lost all its children.
        $(".open-edx-link").each(function (index, item) {
            var $item = $(item);
            if ( $('.menu-item', $item).length === 0) {
                $item.children('.submenu-expand').remove();
            }
        });
    };

    ENEXT.filterInvalids = function () {
        var isLoggedIn = ENEXT.loggedInCookiePresent()

        // Remove the items that are marked by class-wp-edunext-marketing-site-menu-items-attributes.php
        // to be deleted conditionally.
        if (isLoggedIn) {
            for (let item of ENEXT.HIDE_WHEN_LOGGED_IN) {
                $(".menu-item-"+item).remove();
            }
        } else {
            for (let item of ENEXT.HIDE_WHEN_LOGGED_OUT) {
                $(".menu-item-"+item).remove();
            }
        }

        // Alter items based on the backend process_menu_object logic.
        $(".login_or_menu_openedx").each(function(index, item) {
            var $item = $(item);
            if (isLoggedIn) {
                $item.removeClass("login_or_menu_openedx").addClass("menu_openedx");
            }
            else {
                $item.removeClass("login_or_menu_openedx").addClass("login_openedx");
            }
            ENEXT.computeConditionalItem($item, isLoggedIn);
        })
        $(".login_or_dash_openedx").each(function(index, item) {
            var $item = $(item);
            if (isLoggedIn) {
                $item.removeClass("login_or_dash_openedx").addClass("dashboard_openedx");
            }
            else {
                $item.removeClass("login_or_dash_openedx").addClass("login_openedx");
            }
            ENEXT.computeConditionalItem($item, isLoggedIn);
        })

        // Remove items based on the user session.
        if (!isLoggedIn) {
            // Users with no session, don't see this items.
            $(".menu_openedx, .resume_openedx, .dashboard_openedx, .profile_openedx, .account_openedx, .signout_openedx").each(function(index, item) {
                $(item).remove();
            })
        }
        else {
            // Users with session, don't need to see this items.
            $(".login_openedx, .register_openedx").each(function(index, item) {
                $(item).remove();
            })
        }
    };

    ENEXT.renderMenu();
});